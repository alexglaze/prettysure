import { useEffect, useState } from "react";
import { useAuthenticator } from "@aws-amplify/ui-react";

import type { Schema } from "../amplify/data/resource";
import { generateClient } from "aws-amplify/data";

import NavBar from "./components/NavBar";
import HomePage from "./pages/HomePage";
import RatePage from "./pages/RatePage";
import AccountPage from "./pages/AccountPage";
import UpgradePage from "./pages/UpgradePage";

const client = generateClient<Schema>();

type Page = "home" | "rate" | "upgrade" | "account";

export default function App() {
  const { user } = useAuthenticator();

  const [currentPage, setCurrentPage] = useState<Page>("home");
  const [todos, setTodos] = useState<Array<Schema["Todo"]["type"]>>([]);

  // persistent home photo stored here so navigation doesnâ€™t wipe it
  const [persistentPhotoUrl, setPersistentPhotoUrl] = useState<string | null>(null);

  useEffect(() => {
    const sub = client.models.Todo.observeQuery().subscribe({
      next: ({ items }) => setTodos([...items]),
    });
    return () => sub.unsubscribe();
  }, []);

  const renderPage = () => {
    switch (currentPage) {
      case "home":
        return (
          <HomePage
            persistentPhotoUrl={persistentPhotoUrl}
            setPersistentPhotoUrl={setPersistentPhotoUrl}
          />
        );
      case "rate":
        return <RatePage todos={todos} client={client} />;
      case "upgrade":
        return <UpgradePage />;
      case "account":
        return <AccountPage />;
      default:
        return <HomePage />;
    }
  };

  return (
    <div className="app-shell">
      <NavBar
        currentPage={currentPage}
        onNavigate={setCurrentPage}
        userLabel={user?.signInDetails?.loginId || ""}
      />

      {/* padding-top ensures navbar never overlaps home text */}
      <main className="page-content" style={{ paddingTop: "90px" }}>
        {renderPage()}
      </main>
    </div>
  );
}
